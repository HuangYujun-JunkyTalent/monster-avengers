;;;; simple-web.lisp

(in-package #:monster-avengers.simple-web)

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defparameter *dataset-path* 
    (merge-pathnames "dataset/MH4G/"
                     (asdf:system-source-directory 'monster-avengers))))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defpsmacro lang-text (&rest lang-text-pairs)
    `(funcall (lambda (language)
                (case language
                  ,@lang-text-pairs))
              (@ this props language))))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (enable-jsx-reader))

(def-global-code skill-systems
  (with-open-file (in (merge-pathnames "skills.lisp"
                                       *dataset-path*)
                      :direction :input)
    `(array 
      ,@(loop for skill-system in (read in)
           collect (getf skill-system :system-name)))))

(def-widget skill-panel (language)
    ()
  #jsx(:div ((class-name "panel panel-default"))
            (:div ((class-name "panel-heading"))
                  (lang-text ("en" "Skills")
                             ("zh" "技能")))
            (:ul ((class-name "list-group"))
                 (:li ((class-name "list-group-item"))
                      "a")
                 (:li ((class-name "list-group-item"))
                      "b"))
            (:div ((class-name "panel-body"))
                  (:div ((class-name "input-group"))
                        (:select ((class-name "form-control"))
                                 (:option ((value "a")) "a")
                                 (:option ((value "b")) "b"))
                        (:div ((class-name "input-group-btn dropdown"))
                              (:button ((class-name "btn btn-default")) 
                                       (lang-text ("en" "Add")
                                                  ("zh" "添加"))))))))


(def-widget parameter-panel (language)
    ()
  #jsx(:div ((class-name "row"))
            (:div ((class-name "col-md-2"))
                  (:div ((class-name "panel panel-default"))
                        (:div ((class-name "panel-heading"))
                              (:h3 ((class-name "panel-title"))
                                   (lang-text ("en" "Weapon Type")
                                              ("zh" "武器类型"))))
                        (:div ((class-name "panel-body"))
                              (:select ((class-name "form-control"))
                                       (:option ((value "melee"))
                                                (lang-text ("en" "Melee")
                                                           ("zh" "近战")))
                                       (:option ((value "range")) 
                                                (lang-text ("en" "Range")
                                                           ("zh" "远程")))))))
            (:div ((class-name "col-md-2"))
                  (:div ((class-name "panel panel-default"))
                        (:div ((class-name "panel-heading"))
                              (:h3 ((class-name "panel-title"))
                                   (lang-text ("en" "Weapon Holes")
                                              ("zh" "武器孔数"))))
                        (:div ((class-name "panel-body"))
                              (:select ((class-name "form-control"))
                                       (:option ((value "0")) "---")
                                       (:option ((value "1")) "O")
                                       (:option ((value "2")) "OO")
                                       (:option ((value "3")) "OOO")))))
            (:div ((class-name "col-md-2"))
                  (:div ((class-name "panel panel-default"))
                        (:div ((class-name "panel-heading"))
                              (:h3 ((class-name "panel-title"))
                                   (lang-text ("en" "Minimum Rare")
                                              ("zh" "稀有度"))))
                        (:div ((class-name "panel-body"))
                              (:select ((class-name "form-control"))
                                       (:option ((value "1")) "1")
                                       (:option ((value "2")) "2")
                                       (:option ((value "3")) "3")
                                       (:option ((value "4")) "4")
                                       (:option ((value "5")) "5")
                                       (:option ((value "6")) "6")
                                       (:option ((value "7")) "7")
                                       (:option ((value "8")) "8")
                                       (:option ((value "9")) "9")
                                       (:option ((value "10")) "10")))))))

(def-widget title-bar (language callback)
    ()
  #jsx(:div ((class-name "topbar")
             (style :width "auto"
                    :margin "auto"))
            (:div ((class-name "fill row"))
                  (:div ((class-name "col-md-4"))
                        (:div ((class-name "page-header"))
                              (:h1 () (lang-text ("en" "MH4G Armor Tool")
                                                 ("zh" "怪物猎人4G 配装器")))))
                  (:div ((class-name "col-md-2 col-md-offset-6"))
                        (:select ((class-name "form-control")
                                  (on-click (lambda (e)
                                              (funcall callback
                                                       (@ e target value)))))
                                 (:option ((value "en")) "English")
                                 (:option ((value "zh")) "中文"))))))

(def-widget app-view ()
    ((state (language "en"))
     (switch-language (target) 
                      (chain console (log skill-systems))
                      (chain this (set-state (create language target)))))
  #jsx(:div ((style :margin "20px 50px 30px 50px"))
            (:title-bar ((language (@ this state language))
                         (callback (@ this switch-language))))
            (:parameter-panel ((language (@ this state language))))
            (:div ((class-name "row"))
                  (:div ((class-name "col-md-3"))
                        (:skill-panel ((language (@ this state language))))))))


(def-realispic-app (armor-tools :title "Monster Hunter's Arsenal"
                                :port 16384
                                :css ("https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css")
                                :libs ("http://fb.me/react-0.12.2.min.js"
                                       "https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"
                                       "https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js")
                                :document-base (merge-pathnames "assets/"
                                                                (asdf:system-source-directory 'monster-avengers)))
  #jsx(:app-view))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (disable-jsx-reader))
